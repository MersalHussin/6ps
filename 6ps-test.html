<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>رحلة 6Ps - اكتشف ميولك المهنية</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="icon" href="assets/LogoIC.png">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #052ed8;
      --green: #00c309;
      --yellow: #f1c900;
      --background: #f8faff;
      --card-bg: #ffffff;
      --text: #0f172a;
      --text-light: #64748b;
      --border: #e2e8f0;
      --error: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(5, 46, 216, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      text-align: center;
      margin: 2rem 0;
      color: var(--primary);
      font-weight: 700;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .card-header {
      padding: 1.5rem;
      background: var(--primary);
      color: white;
    }

    .card-title {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .card-description {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.95rem;
    }

    .card-content {
      padding: 1.5rem;
    }

    .card-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      background: #f8fafc;
    }

    .input-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
      min-width: 250px;
    }

    .input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .hint-button {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--yellow);
      border: none;
      cursor: pointer;
      color: #333;
      font-size: 10px;
      padding: 10px;
      border-radius: 50%;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .hint-button:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .hint-tooltip {
      position: absolute;
      left: -10px;
      bottom: 100%;
      margin-bottom: 10px;
      background: var(--text);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.4;
      width: 280px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
      text-align: right;
    }

    .hint-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 20px;
      border: 6px solid transparent;
      border-top-color: var(--text);
    }

    .hint-button:hover .hint-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .select {
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      background: white;
      min-width: 140px;
      cursor: pointer;
    }

    .select:focus {
      outline: none;
      border-color: var(--green);
    }

    .button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 1.5rem;
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 120px;
    }

    .button:hover {
      background: #041db8;
      transform: translateY(-1px);
    }

    .button:disabled {
      background: #cacaca;
      color: white;
      cursor: not-allowed;
      transform: none;
    }

    .button-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .button-outline:hover {
      background: var(--primary);
      color: white;
    }

    .button-success {
      background: var(--green);
    }

    .button-success:hover {
      background: #009907;
    }

    .button-warning {
      background: var(--yellow);
      color: #333;
    }

    .button-warning:hover {
      background: #d1a800;
    }

    /* تبسيط الجداول */
    .table-container {
      overflow-x: auto;
      margin: 1rem 0;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      min-width: 600px;
    }

    .table th,
    .table td {
      padding: 1rem;
      text-align: right;
      border-bottom: 1px solid var(--border);
    }

    .table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .table tr:hover {
      background: #f8fafc;
    }

    .table-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }

    .action-button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.4rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .action-button:hover {
      transform: translateY(-1px);
    }

    .delete-button {
      background: var(--error);
    }

    .action-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .alert {
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      display: none;
      font-weight: 500;
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--green), var(--yellow), var(--primary));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .guiding-question {
      font-size: 1.1rem;
      color: var(--text);
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      background: #f0f4ff;
      border-radius: var(--radius);
      border-right: 4px solid var(--primary);
    }

    .hidden {
      display: none;
    }

    .result-highlight {
      background: #f0f4ff;
      padding: 1.5rem;
      border-radius: var(--radius);
      margin: 1.5rem 0;
      border: 2px solid var(--primary);
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 2rem 0 1rem;
      color: var(--primary);
      border-bottom: 2px solid var(--green);
      padding-bottom: 0.5rem;
    }

    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      text-align: center;
      font-weight: 500;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(10px);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      color: white;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .print-only {
      display: none;
    }

    .icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      stroke-width: 0;
      stroke: currentColor;
      fill: currentColor;
    }

    .best-result {
      background: #e8f5e8 !important;
      color: var(--green) !important;
      font-weight: bold !important;
    }

    /* Print styles */
    @media print {
      * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      body {
        background: white !important;
        font-size: 12pt;
        margin: 0;
        padding: 0;
        color: black;
        font-family: 'Tajawal', Arial, sans-serif;
      }

      .container {
        width: 100%;
        max-width: none;
        padding: 20px;
        margin: 0 auto;
      }

      .print-content {
        width: 100%;
        margin: 0 auto;
        text-align: center;
      }

      .print-section {
        width: 100%;
        margin-bottom: 30px;
        page-break-inside: avoid;
        text-align: center;
      }

      .print-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 3px solid #052ed8;
        padding-bottom: 20px;
      }

      .print-header h1 {
        color: #052ed8 !important;
        font-size: 24pt;
        margin-bottom: 10px;
        font-weight: bold;
      }

      table {
        width: 90%;
        margin: 20px auto;
        border-collapse: collapse;
        font-size: 11pt;
        border: 1px solid #ddd;
      }

      th, td {
        padding: 12px 8px;
        border: 1px solid #ddd;
        text-align: center;
      }

      th {
        background-color: #f0f4ff !important;
        color: #052ed8 !important;
        font-weight: bold;
      }

      .best-result {
        background-color: #e8f5e8 !important;
        color: #00c309 !important;
        font-weight: bold !important;
      }

      .print-passion-section {
        width: 90%;
        margin: 0 auto 25px auto;
        border: 2px solid #052ed8;
        border-radius: 8px;
        padding: 20px;
        page-break-inside: avoid;
        background: #fafbff;
      }

      .print-passion-title {
        color: #052ed8 !important;
        font-size: 16pt;
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
        border-bottom: 2px solid #00c309;
        padding-bottom: 8px;
      }

      .print-stage-section {
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e7ff;
      }

      .print-stage-title {
        color: #00c309 !important;
        font-size: 14pt;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
      }

      .print-question {
        font-style: italic;
        color: #666 !important;
        margin-bottom: 10px;
        font-size: 11pt;
        background-color: #f8f9ff;
        padding: 10px;
        border-radius: 6px;
        text-align: right;
        line-height: 1.5;
      }

      .print-answers {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .print-answer-item {
        margin-bottom: 6px;
        font-size: 11pt;
        padding: 8px 12px;
        background: #f9f9f9;
        border-radius: 4px;
        text-align: right;
        border-right: 3px solid #052ed8;
      }

      .print-total {
        background: #fff3cd !important;
        border: 2px solid #f1c900 !important;
        color: #856404 !important;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        border-radius: 6px;
        margin-top: 10px;
        font-size: 13pt;
      }

      .print-recommendation {
        background: #e8f5e8 !important;
        border: 3px solid #00c309 !important;
        color: #00c309 !important;
        padding: 20px;
        text-align: center;
        font-weight: bold;
        border-radius: 10px;
        margin: 20px auto;
        font-size: 15pt;
        width: 80%;
      }

      .print-hint {
        background: #fff3cd !important;
        border: 2px solid #f1c900 !important;
        color: #856404 !important;
        padding: 15px;
        border-radius: 8px;
        margin: 15px auto;
        line-height: 1.6;
        font-size: 12pt;
        width: 80%;
        text-align: right;
      }

      .no-print {
        display: none !important;
      }

      .print-only {
        display: block !important;
      }

      @page {
        margin: 2cm;
        size: A4;
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.8rem;
        margin: 1rem 0;
      }

      .card-header,
      .card-content,
      .card-footer {
        padding: 1rem;
      }

      .card-footer {
        flex-direction: column-reverse;
        align-items: stretch;
      }

      .card-footer .button {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .input-group {
        flex-direction: column;
        align-items: stretch;
      }

      .input-wrapper {
        min-width: auto;
      }

      .select {
        width: 100%;
        min-width: auto;
      }

      .button {
        width: 100%;
        min-width: auto;
      }

      /* تحسين الجداول للموبايل */
      .table-container {
        margin: 0.5rem 0;
      }

      .table {
        min-width: auto;
        font-size: 0.85rem;
      }

      .table th,
      .table td {
        padding: 0.5rem 0.3rem;
        font-size: 0.8rem;
      }

      .table th {
        font-size: 0.75rem;
      }

      .table-actions {
        flex-direction: row;
        gap: 0.25rem;
      }

      .action-button {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
      }

      .hint-tooltip {
        width: 250px;
        left: -50px;
        font-size: 0.8rem;
      }

      .progress-text {
        font-size: 0.8rem;
      }

      .guiding-question {
        font-size: 1rem;
        padding: 1rem;
      }

      .result-highlight {
        font-size: 1.1rem;
        padding: 1rem;
      }

      .modal {
        width: 95%;
        margin: 10px;
      }

      .modal-footer {
        flex-direction: column;
      }

      .modal-footer .button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .card-header,
      .card-content,
      .card-footer {
        padding: 0.75rem;
      }

      .table th,
      .table td {
        padding: 10px 15px ;
        font-size: 0.75rem;
      }

      .table th {
        font-size: 0.7rem;
      }

      .action-button {
        width: 24px;
        height: 24px;
      }

      .hint-tooltip {
        width: 200px;
        left: -5px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .container {
        padding: 18px;
      }

      .table th,
      .table td {
        padding: 0.8rem;
      }
    }

    /* تحسين الجداول للشاشات الكبيرة */
    @media (min-width: 1200px) {
      .table th,
      .table td {
        padding: 1.2rem;
      }
    }

    .Logo-image{
      width: 250px;
    display: flex
;
    justify-content: center;
    align-items: center;
    margin: auto;
    }
       .Language-button{
        color: white;
        background-color: var(--green);
        font-size: 20px;
        position: absolute;
        text-decoration: none;
        padding: 5px 15px;
        border-radius: 10px;
    }

  </style>
</head>
<body>
  <div class="container">
    <a href="/6ps/6ps-test-en.html" class="Language-button">الإنجليزية</a>
    <img src="assets/Logo.png" alt="Logo Qudraat Shabab" class="Logo-image">
    <h1>رحلة 6Ps - اكتشف ميولك المهنية</h1>

    <!-- إدخال الشغف -->
    <div id="passion-selection" class="card">
      <div class="card-header">
        <h2 class="card-title">أدخل 6 شغف</h2>
        <p class="card-description">أدخل الشغف الذي تهتم به. يمكنك تغيير الترتيب لاحقاً.</p>
      </div>
      <div class="card-content">
        <div id="passion-error" class="alert">أدخل اسم شغف صالح (مثل: البرمجة، التصميم)!</div>
        <div class="input-group">
          <div class="input-wrapper">
            <input type="text" id="passion-input" class="input" placeholder="أدخل شغفك (مثل: البرمجة)">
            <button class="hint-button" type="button">
              💡
              <div class="hint-tooltip">
                أمثلة على الشغف: البرمجة، التصميم، التدريس، الطبخ، الكتابة، التصوير، الرياضة، الموسيقى، ريادة الأعمال، الطب، الهندسة، التسويق
              </div>
            </button>
          </div>
          <button id="add-passion" class="button">إضافة</button>
        </div>
        <div class="table-container">
          <table id="passion-table" class="table">
            <thead>
              <tr>
                <th>الشغف</th>
                <th>الترتيب</th>
                <th>إجراء</th>
              </tr>
            </thead>
            <tbody id="passion-list"></tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <button id="start-journey" class="button button-success" disabled>ابدأ الرحلة</button>
      </div>
    </div>

    <!-- مراحل الأسئلة -->
    <div id="question-section" class="card hidden">
      <div class="card-header">
        <div class="progress-container">
          <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
        </div>
        <div class="progress-text">
          <span id="progress-text">السؤال 1 من 30</span>
          <span id="remaining-text">المتبقي: 29</span>
        </div>
        <h2 id="current-passion" class="card-title">الشغف: </h2>
        <h3 id="current-stage" class="card-description">المرحلة: </h3>
      </div>
      <div class="card-content">
        <div id="guiding-question" class="guiding-question"></div>
        <div id="question-error" class="alert">أدخل إجابة صالحة لكل حقل مع تحديد التقييم!</div>
        <div id="question-inputs"></div>
        <button id="add-input" class="button button-outline">إضافة إدخال</button>
      </div>
      <div class="card-footer">
        <button id="prev-question" class="button button-outline" disabled>السابق</button>
        <button id="next-question" class="button button-success">التالي</button>
      </div>
    </div>

    <!-- النتائج -->
    <div id="results-section" class="card hidden">
      <div class="card-header">
        <h2 class="card-title">النتائج</h2>
      </div>
      <div class="card-content">
        <h3 class="section-title">الترتيب بناءً على الاختبار</h3>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>الشغف</th>
                <th>Purpose</th>
                <th>Problems</th>
                <th>Power</th>
                <th>Proof</th>
                <th>Possible</th>
                <th>الإجمالي</th>
              </tr>
            </thead>
            <tbody id="results-table"></tbody>
          </table>
        </div>
        <div id="recommendation" class="result-highlight"></div>
        <h3 class="section-title">الترتيب الذي اخترته</h3>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>الشغف</th>
                <th>الترتيب</th>
              </tr>
            </thead>
            <tbody id="user-priority-table"></tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <button id="restart-test" class="button button-outline">إعادة الاختبار</button>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button id="print-report" class="button button-success">طباعة التقرير</button>
          <button id="download-report" class="button button-warning">تحميل التقرير</button>
        </div>
      </div>
    </div>

    <!-- نافذة منبثقة للإشعارات -->
    <div id="toast" class="toast"></div>

    <!-- نافذة استعادة البيانات -->
    <div id="restore-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">استعادة البيانات</h3>
          <button class="modal-close" onclick="closeModal('restore-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <p>تم العثور على بيانات محفوظة من جلسة سابقة. هل ترغب في استعادتها واستكمال الاختبار؟</p>
        </div>
        <div class="modal-footer">
          <button class="button button-outline" onclick="clearSavedData()">بدء اختبار جديد</button>
          <button class="button button-success" onclick="restoreSavedData()">استكمال الاختبار السابق</button>
        </div>
      </div>
    </div>

    <!-- محتوى الطباعة -->
    <div id="print-content" class="print-only">
      <div class="print-header">
        <h1>تقرير رحلة 6Ps - اكتشف ميولك المهنية</h1>
        <p style="color: #666; font-size: 12pt; margin-top: 10px;">تقرير شامل يحتوي على جميع الإجابات والنتائج</p>
      </div>
      <div class="print-content">
        <div id="print-passions" class="print-section">
          <h2 style="color: #052ed8; font-size: 18pt; margin-bottom: 15px;">الشغف المُدخل</h2>
          <div id="print-passions-content"></div>
        </div>
        <div id="print-answers" class="print-section">
          <h2 style="color: #052ed8; font-size: 18pt; margin-bottom: 15px;">إجابات المراحل مرتبة حسب النتائج</h2>
          <div id="print-answers-content"></div>
        </div>
        <div id="print-results" class="print-section">
          <h2 style="color: #052ed8; font-size: 18pt; margin-bottom: 15px;">النتائج النهائية</h2>
          <div id="print-results-content"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SVG Icons -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="icon-pencil" viewBox="0 0 24 24">
      <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
    </symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24">
      <path d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19V4Z" />
    </symbol>
    <symbol id="icon-arrow-up" viewBox="0 0 24 24">
      <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" />
    </symbol>
    <symbol id="icon-arrow-down" viewBox="0 0 24 24">
      <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
    </symbol>
  </svg>

  <script>
    // تعريف المتغيرات الرئيسية
    const passions = [];
    const stages = ['Purpose', 'Problems', 'Power', 'Proof', 'Possible'];
    const guidingQuestions = {
      Purpose: 'ما الغرض أو الهدف الأساسي من هذا الشغف؟ كيف يؤثر إيجابيًا على حياتك أو الآخرين؟',
      Problems: 'ما التحديات أو العقبات التي قد تواجهها في هذا الشغف؟ ما الذي يقلقك؟',
      Power: 'ما نقاط القوة أو المهارات التي تمتلكها تدعم هذا الشغف؟',
      Proof: 'ما الأدلة أو الإنجازات التي تثبت قدرتك على النجاح في هذا الشغف؟',
      Possible: 'ما الفرص المستقبلية التي يمكن أن يفتحها هذا الشغف؟ كيف يمكن أن يتطور؟'
    };

    // نصائح لكل مرحلة
    const stageHints = {
      Purpose: [
        'فكر في الهدف الأساسي: لماذا تحب هذا المجال؟ ما الذي يدفعك إليه؟',
        'اكتب عن التأثير الإيجابي: كيف يمكن أن يفيد هذا الشغف الآخرين أو المجتمع؟',
        'حدد القيم: ما القيم الشخصية التي يحققها لك هذا الشغف؟'
      ],
      Problems: [
        'فكر في التحديات المالية: هل يحتاج استثمار كبير؟ هل الدخل مستقر؟',
        'اذكر العقبات التقنية: ما المهارات التي تحتاج تطويرها؟',
        'حدد المخاطر: ما أكبر المخاوف التي تواجهك في هذا المجال؟'
      ],
      Power: [
        'اذكر مهاراتك الحالية: ما المهارات التي تمتلكها بالفعل؟',
        'حدد نقاط قوتك الشخصية: الصبر، الإبداع، التواصل، القيادة، إلخ',
        'اكتب عن خبراتك السابقة: أي تجارب سابقة تدعم هذا الشغف؟'
      ],
      Proof: [
        'اذكر إنجازاتك: أي مشاريع أو أعمال قمت بها في هذا المجال؟',
        'حدد الشهادات أو الدورات: أي تعليم رسمي أو غير رسمي حصلت عليه؟',
        'اكتب عن التقدير: أي مدح أو تقدير حصلت عليه من الآخرين؟'
      ],
      Possible: [
        'فكر في الفرص المستقبلية: ما الوظائف أو المشاريع المتاحة؟',
        'حدد إمكانيات النمو: كيف يمكن تطوير هذا الشغف مع الوقت؟',
        'اكتب عن الاتجاهات: ما التطورات الجديدة في هذا المجال؟'
      ]
    };
    
    let currentPassionIndex = 0;
    let currentStageIndex = 0;
    let previousPassionIndex = -1;
    const answers = {};
    const userPriorities = {};
    let currentStep = "selection"; // selection, questions, results

    // العناصر المستخدمة
    const passionInput = document.getElementById('passion-input');
    const addPassionBtn = document.getElementById('add-passion');
    const passionError = document.getElementById('passion-error');
    const passionList = document.getElementById('passion-list');
    const startJourneyBtn = document.getElementById('start-journey');
    const passionSelection = document.getElementById('passion-selection');
    const questionSection = document.getElementById('question-section');
    const resultsSection = document.getElementById('results-section');
    const currentPassionEl = document.getElementById('current-passion');
    const currentStageEl = document.getElementById('current-stage');
    const guidingQuestionEl = document.getElementById('guiding-question');
    const questionInputs = document.getElementById('question-inputs');
    const questionError = document.getElementById('question-error');
    const addInputBtn = document.getElementById('add-input');
    const prevQuestionBtn = document.getElementById('prev-question');
    const nextQuestionBtn = document.getElementById('next-question');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const remainingText = document.getElementById('remaining-text');
    const resultsTable = document.getElementById('results-table');
    const userPriorityTable = document.getElementById('user-priority-table');
    const recommendation = document.getElementById('recommendation');
    const restartTestBtn = document.getElementById('restart-test');
    const downloadReportBtn = document.getElementById('download-report');
    const printReportBtn = document.getElementById('print-report');
    const toast = document.getElementById('toast');
    const restoreModal = document.getElementById('restore-modal');

    // إدارة النوافذ المنبثقة
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // عرض نافذة منبثقة
    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // حفظ البيانات في localStorage
    function saveData() {
      const data = {
        passions: passions,
        userPriorities: userPriorities,
        answers: answers,
        currentPassionIndex: currentPassionIndex,
        currentStageIndex: currentStageIndex,
        currentStep: currentStep
      };
      
      localStorage.setItem('6ps_journey_data', JSON.stringify(data));
    }

    // التحقق من وجود بيانات محفوظة
    function checkSavedData() {
      const savedData = localStorage.getItem('6ps_journey_data');
      if (savedData) {
        const data = JSON.parse(savedData);
        if (data.passions && data.passions.length > 0) {
          showModal('restore-modal');
          return true;
        }
      }
      return false;
    }

    // استعادة البيانات المحفوظة
    function restoreSavedData() {
      const savedData = localStorage.getItem('6ps_journey_data');
      if (savedData) {
        const data = JSON.parse(savedData);
        
        // استعادة البيانات
        data.passions.forEach(p => passions.push(p));
        Object.assign(userPriorities, data.userPriorities);
        Object.assign(answers, data.answers);
        currentPassionIndex = data.currentPassionIndex;
        currentStageIndex = data.currentStageIndex;
        currentStep = data.currentStep;
        
        // عرض الشاشة المناسبة
        if (currentStep === "questions") {
          passionSelection.classList.add('hidden');
          questionSection.classList.remove('hidden');
          resultsSection.classList.add('hidden');
          showQuestion();
        } else if (currentStep === "results") {
          passionSelection.classList.add('hidden');
          questionSection.classList.add('hidden');
          resultsSection.classList.remove('hidden');
          showResults();
        } else {
          updatePassionSelection();
        }
        
        closeModal('restore-modal');
        showToast('تم استعادة البيانات بنجاح');
      }
    }

    // مسح البيانات المحفوظة وبدء اختبار جديد
    function clearSavedData() {
      localStorage.removeItem('6ps_journey_data');
      closeModal('restore-modal');
      showToast('تم بدء اختبار جديد');
    }

    // إدارة إدخال الشغف
    function updatePassionSelection() {
      const passionCount = passions.length;
      startJourneyBtn.disabled = passionCount !== 6;
      passionInput.disabled = passionCount >= 6;
      addPassionBtn.disabled = passionCount >= 6;
      renderPassionList();
      
      // حفظ البيانات
      currentStep = "selection";
      saveData();
    }

    // إضافة شغف جديد
    addPassionBtn.addEventListener('click', () => {
      const value = passionInput.value.trim();

      if (value && passions.length < 6 && !passions.includes(value)) {
        passions.push(value);
        userPriorities[value] = 6 - passions.length + 1;
        passionInput.value = '';
        passionError.style.display = 'none';
        updatePassionSelection();
      } else {
        passionError.style.display = 'block';
        setTimeout(() => {
          passionError.style.display = 'none';
        }, 3000);
      }
    });

    // إضافة شغف عند الضغط على Enter
    passionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        addPassionBtn.click();
      }
    });

    // عرض جدول الشغف
    function renderPassionList() {
      passionList.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const passion = passions[i] || '';
        const priority = passion ? userPriorities[passion] : '-';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${passion || '-'}</td>
          <td>${priority}</td>
          <td>
            ${passion ? `
              <div class="table-actions">
                <button class="action-button" onclick="editPassion(${i})" title="تعديل">
                  <svg class="icon"><use xlink:href="#icon-pencil"></use></svg>
                </button>
                <button class="action-button delete-button" onclick="deletePassion(${i})" title="حذف">
                  <svg class="icon"><use xlink:href="#icon-trash"></use></svg>
                </button>
                <button class="action-button" ${i === 0 ? 'disabled' : ''} onclick="movePassion(${i}, -1)" title="لأعلى">
                  <svg class="icon"><use xlink:href="#icon-arrow-up"></use></svg>
                </button>
                <button class="action-button" ${i === passions.length - 1 ? 'disabled' : ''} onclick="movePassion(${i}, 1)" title="لأسفل">
                  <svg class="icon"><use xlink:href="#icon-arrow-down"></use></svg>
                </button>
              </div>
            ` : '-'}
          </td>
        `;
        passionList.appendChild(row);
      }
    }

    // تعديل شغف
    window.editPassion = function(index) {
      const passion = passions[index];
      const newValue = prompt('أدخل اسم الشغف الجديد:', passion);

      if (newValue && newValue.trim() && !passions.includes(newValue.trim())) {
        delete userPriorities[passion];
        passions[index] = newValue.trim();
        userPriorities[newValue.trim()] = 6 - index;
        updatePassionSelection();
      } else if (newValue) {
        alert('خطأ: الاسم غير صالح أو مكرر!');
      }
    };

    // مسح شغف
    window.deletePassion = function(index) {
      const passion = passions[index];
      delete userPriorities[passion];
      passions.splice(index, 1);
      reassignPriorities();
      updatePassionSelection();
    };

    // نقل شغف لأعلى أو لأسفل
    window.movePassion = function(index, direction) {
      const newIndex = index + direction;
      if (newIndex >= 0 && newIndex < passions.length) {
        [passions[index], passions[newIndex]] = [passions[newIndex], passions[index]];
        reassignPriorities();
        updatePassionSelection();
      }
    };

    // إعادة ترتيب الأولويات
    function reassignPriorities() {
      const newPriorities = {};
      passions.forEach((passion, index) => {
        newPriorities[passion] = 6 - index;
      });
      Object.assign(userPriorities, newPriorities);
    }

    // بدء الرحلة
    startJourneyBtn.addEventListener('click', () => {
      if (passions.length !== 6) {
        alert('يرجى إدخال 6 شغف بالضبط!');
        return;
      }
      passions.forEach(p => {
        if (!answers[p]) {
          answers[p] = { Purpose: [], Problems: [], Power: [], Proof: [], Possible: [] };
        }
      });
      passionSelection.classList.add('hidden');
      questionSection.classList.remove('hidden');
      previousPassionIndex = -1;
      currentStep = "questions";
      showQuestion();
    });

    // عرض السؤال الحالي
    function showQuestion() {
      const passion = passions[currentPassionIndex];
      const stage = stages[currentStageIndex];
      const totalQuestions = passions.length * stages.length;
      const currentQuestion = currentPassionIndex * stages.length + currentStageIndex + 1;
      const remainingQuestions = totalQuestions - currentQuestion;

      // إظهار نافذة منبثقة عند الانتقال لشغف جديد
      if (currentPassionIndex !== previousPassionIndex) {
        showToast(`الآن تجيب على أسئلة: ${passion}`);
        previousPassionIndex = currentPassionIndex;
      }

      // تحديث شريط التقدم
      progressBar.style.width = `${(currentQuestion / totalQuestions) * 100}%`;
      progressText.textContent = `السؤال ${currentQuestion} من ${totalQuestions}`;
      remainingText.textContent = `المتبقي: ${remainingQuestions}`;

      currentPassionEl.textContent = `الشغف: ${passion}`;
      currentStageEl.textContent = `المرحلة: ${stage}`;
      guidingQuestionEl.textContent = guidingQuestions[stage];

      questionInputs.innerHTML = '';
      const currentAnswers = answers[passion][stage];
      const inputCount = currentAnswers.length || 3;

      for (let i = 0; i < inputCount; i++) {
        addInputField(questionInputs, currentAnswers[i]?.text || '', currentAnswers[i]?.rating || 0, stage, i);
      }

      addInputBtn.disabled = inputCount >= 6;
      prevQuestionBtn.disabled = currentQuestion === 1;
      
      // حفظ البيانات
      saveData();
    }

    // إضافة حقل إدخال
    function addInputField(container, text = '', rating = 0, stage, index) {
      const div = document.createElement('div');
      div.className = 'input-group';
      
      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'input-wrapper';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'input';
      input.value = text;
      input.placeholder = 'أدخل إجابتك';
      inputWrapper.appendChild(input);
      
      // إضافة زر النصيحة
      const hintButton = document.createElement('button');
      hintButton.className = 'hint-button';
      hintButton.type = 'button';
      hintButton.innerHTML = '💡';
      
      const hintTooltip = document.createElement('div');
      hintTooltip.className = 'hint-tooltip';
      
      // اختيار نصيحة عشوائية من المرحلة الحالية
      const hints = stageHints[stage];
      const randomHint = hints[Math.floor(Math.random() * hints.length)];
      hintTooltip.textContent = randomHint;
      
      hintButton.appendChild(hintTooltip);
      inputWrapper.appendChild(hintButton);
      div.appendChild(inputWrapper);
      
      const isProblems = stage === 'Problems';
      const selectLabel = document.createElement('label');
      selectLabel.textContent = isProblems ? 'مستوى القلق:' : 'مستوى الاقتناع:';
      selectLabel.style.minWidth = '100px';
      selectLabel.style.fontWeight = '500';
      div.appendChild(selectLabel);
      
      const select = document.createElement('select');
      select.className = 'select';
      
      const options = [
        { value: '', label: 'اختر المستوى' },
        { value: isProblems ? '-2' : '2', label: 'بسيط' },
        { value: isProblems ? '-4' : '4', label: 'متوسط' },
        { value: isProblems ? '-6' : '6', label: 'عالي' }
      ];
      
      options.forEach(option => {
        const optionEl = document.createElement('option');
        optionEl.value = option.value;
        optionEl.textContent = option.label;
        if (rating.toString() === option.value) {
          optionEl.selected = true;
        }
        select.appendChild(optionEl);
      });
      
      div.appendChild(select);
      
      if (index >= 3) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'button button-outline';
        deleteBtn.style.padding = '0.5rem';
        deleteBtn.style.minWidth = 'auto';
        deleteBtn.innerHTML = '<svg class="icon"><use xlink:href="#icon-trash"></use></svg>';
        deleteBtn.onclick = function() {
          deleteInputField(this);
        };
        div.appendChild(deleteBtn);
      }
      
      container.appendChild(div);
    }

    // مسح حقل إدخال
    window.deleteInputField = function(button) {
      if (questionInputs.children.length > 3) {
        button.parentElement.remove();
        addInputBtn.disabled = questionInputs.children.length >= 6;
      }
    };

    // إضافة إدخال جديد
    addInputBtn.addEventListener('click', () => {
      if (questionInputs.children.length < 6) {
        addInputField(questionInputs, '', 0, stages[currentStageIndex], questionInputs.children.length);
        addInputBtn.disabled = questionInputs.children.length >= 6;
      }
    });

    // الرجوع للسؤال السابق
    prevQuestionBtn.addEventListener('click', () => {
      if (currentStageIndex > 0) {
        currentStageIndex--;
      } else if (currentPassionIndex > 0) {
        currentPassionIndex--;
        currentStageIndex = stages.length - 1;
      }
      showQuestion();
    });

    // الانتقال للسؤال التالي
    nextQuestionBtn.addEventListener('click', () => {
      const passion = passions[currentPassionIndex];
      const stage = stages[currentStageIndex];
      const inputGroups = questionInputs.querySelectorAll('.input-group');
      const newAnswers = [];

      let valid = true;
      inputGroups.forEach(group => {
        const text = group.querySelector('input').value.trim();
        const select = group.querySelector('select');
        const rating = select.value;
        
        if (text && rating) {
          newAnswers.push({ text, rating: parseInt(rating) });
        } else {
          valid = false;
        }
      });

      if (!valid) {
        questionError.style.display = 'block';
        setTimeout(() => {
          questionError.style.display = 'none';
        }, 3000);
        return;
      }

      answers[passion][stage] = newAnswers;

      currentStageIndex++;
      if (currentStageIndex >= stages.length) {
        currentStageIndex = 0;
        currentPassionIndex++;
      }
      if (currentPassionIndex >= passions.length) {
        currentStep = "results";
        saveData();
        showResults();
      } else {
        showQuestion();
      }
    });

    // عرض النتائج
    function showResults() {
      questionSection.classList.add('hidden');
      resultsSection.classList.remove('hidden');
      resultsTable.innerHTML = '';

      let passionResults = [];

      // حساب النتائج بناءً على التقييمات
      passions.forEach(passion => {
        const stageSums = stages.map(stage => 
          answers[passion][stage].reduce((sum, ans) => sum + parseInt(ans.rating), 0)
        );
        const total = stageSums.reduce((sum, val) => sum + val, 0);
        
        passionResults.push({
          passion: passion,
          stageSums: stageSums,
          total: total
        });
      });

      // ترتيب النتائج من الأعلى للأقل
      passionResults.sort((a, b) => b.total - a.total);

      // عرض النتائج المرتبة
      passionResults.forEach((result, index) => {
        const row = document.createElement('tr');
        // إضافة كلاس للنتيجة الأفضل
        if (index === 0) {
          row.classList.add('best-result');
        }
        row.innerHTML = `
          <td>${result.passion}</td>
          ${result.stageSums.map(p => `<td>${p}</td>`).join('')}
          <td style="font-weight: bold;">${result.total}</td>
        `;
        resultsTable.appendChild(row);
      });

      const topPassion = passionResults[0];
      recommendation.innerHTML = `
        <div>
          <h3 style="color: var(--green); margin-bottom: 10px;">🎯 الشغف المقترح</h3>
          <p style="font-size: 1.3em; font-weight: bold; color: var(--primary);">${topPassion.passion}</p>
          <p style="color: var(--text-light); margin-top: 5px;">بإجمالي ${topPassion.total} نقطة</p>
        </div>
      `;

      // إضافة النصيحة الشخصية
      const hint = generatePersonalHint(topPassion.passion);
      if (hint) {
        const hintElement = document.createElement('div');
        hintElement.className = 'result-highlight';
        hintElement.style.marginTop = '1.5rem';
        hintElement.style.background = '#fff3cd';
        hintElement.style.borderColor = 'var(--yellow)';
        hintElement.innerHTML = `
          <div>
            <h3 style="color: var(--yellow); margin-bottom: 10px;">💡 نصيحة شخصية</h3>
            <p style="font-size: 1em; line-height: 1.6; color: var(--text);">${hint}</p>
          </div>
        `;
        recommendation.parentNode.insertBefore(hintElement, recommendation.nextSibling);
      }

      // جدول الأولويات الأصلية
      userPriorityTable.innerHTML = '';
      const sortedPassions = [...passions].sort((a, b) => userPriorities[b] - userPriorities[a]);
      sortedPassions.forEach(passion => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${passion}</td>
          <td>${userPriorities[passion]}</td>
        `;
        userPriorityTable.appendChild(row);
      });

      // تحضير محتوى الطباعة
      preparePrintContent();
    }

    // دالة لتوليد النصيحة الشخصية
    function generatePersonalHint(topPassion) {
      const purposeAnswers = answers[topPassion]['Purpose'];
      
      // البحث عن أول إجابة بمستوى عالي (6 نقاط) في Purpose
      const highPurposeAnswer = purposeAnswers.find(answer => parseInt(answer.rating) === 6);
      
      if (highPurposeAnswer) {
        return `بناءً على إجاباتك، أنت مناسب جداً لمجال "${topPassion}" لأنك ذكرت: "${highPurposeAnswer.text}". هذا يُظهر وضوح رؤيتك وقوة دافعيتك في هذا المجال. ننصحك بالتركيز على تطوير مهاراتك في هذا الاتجاه والبحث عن الفرص التي تتماشى مع هذا الهدف.`;
      }
      
      // إذا لم توجد إجابة بمستوى عالي، ابحث عن أول إجابة بمستوى متوسط
      const mediumPurposeAnswer = purposeAnswers.find(answer => parseInt(answer.rating) === 4);
      
      if (mediumPurposeAnswer) {
        return `أنت تُظهر اهتماماً واضحاً بمجال "${topPassion}" خاصة فيما يتعلق بـ "${mediumPurposeAnswer.text}". ننصحك بالاستمرار في استكشاف هذا المجال وتطوير فهمك له أكثر.`;
      }
      
      // إذا لم توجد إجابات مناسبة، أعطِ نصيحة عامة
      return `مجال "${topPassion}" يبدو الأنسب لك بناءً على إجاباتك. ننصحك بالتعمق أكثر في هذا المجال واستكشاف الفرص المتاحة فيه.`;
    }

    // تحضير محتوى الطباعة
    function preparePrintContent() {
      // محتوى الشغف
      const printPassionsContent = document.getElementById('print-passions-content');
      printPassionsContent.innerHTML = '';
      const passionsTable = document.createElement('table');
      
      let passionsHtml = '<tr><th>الشغف</th><th>الترتيب الأصلي</th></tr>';
      
      passions.forEach(passion => {
        passionsHtml += `<tr><td>${passion}</td><td>${userPriorities[passion]}</td></tr>`;
      });
      
      passionsTable.innerHTML = passionsHtml;
      printPassionsContent.appendChild(passionsTable);
      
      // محتوى الإجابات مرتبة حسب النتائج
      const printAnswersContent = document.getElementById('print-answers-content');
      printAnswersContent.innerHTML = '';

      // حساب وترتيب النتائج
      let passionResults = [];
      passions.forEach(passion => {
        const stageSums = stages.map(stage => 
          answers[passion][stage].reduce((sum, ans) => sum + parseInt(ans.rating), 0)
        );
        const total = stageSums.reduce((sum, val) => sum + val, 0);
        
        passionResults.push({
          passion: passion,
          stageSums: stageSums,
          total: total
        });
      });

      // ترتيب النتائج من الأعلى للأقل
      passionResults.sort((a, b) => b.total - a.total);

      passionResults.forEach((result, index) => {
        const passionDiv = document.createElement('div');
        passionDiv.className = 'print-passion-section';
        
        const passionTitle = document.createElement('h3');
        passionTitle.className = 'print-passion-title';
        passionTitle.textContent = `${index + 1}. الشغف: ${result.passion}`;
        passionDiv.appendChild(passionTitle);
        
        stages.forEach(stage => {
          const stageDiv = document.createElement('div');
          stageDiv.className = 'print-stage-section';
          
          const stageTitle = document.createElement('h4');
          stageTitle.className = 'print-stage-title';
          stageTitle.textContent = stage;
          stageDiv.appendChild(stageTitle);
          
          const questionP = document.createElement('p');
          questionP.className = 'print-question';
          questionP.textContent = `السؤال التوجيهي: ${guidingQuestions[stage]}`;
          stageDiv.appendChild(questionP);
          
          const answersList = document.createElement('ul');
          answersList.className = 'print-answers';
          
          // ترتيب الإجابات حسب التقييم
          const sortedAnswers = [...answers[result.passion][stage]].sort((a, b) => {
            if (stage === 'Problems') {
              return parseInt(b.rating) - parseInt(a.rating);
            }
            return parseInt(b.rating) - parseInt(a.rating);
          });
          
          sortedAnswers.forEach(answer => {
            const answerItem = document.createElement('li');
            answerItem.className = 'print-answer-item';
            answerItem.textContent = `${answer.text} (التقييم: ${answer.rating})`;
            answersList.appendChild(answerItem);
          });
          
          stageDiv.appendChild(answersList);
          passionDiv.appendChild(stageDiv);
        });

        // إضافة الإجمالي
        const totalDiv = document.createElement('div');
        totalDiv.className = 'print-total';
        totalDiv.textContent = `الإجمالي: ${result.total} نقطة`;
        passionDiv.appendChild(totalDiv);
        
        printAnswersContent.appendChild(passionDiv);
      });
      
      // محتوى النتائج
      const printResultsContent = document.getElementById('print-results-content');
      printResultsContent.innerHTML = '';

      const resultsTable = document.createElement('table');
      
      let resultsHtml = '<tr><th>الترتيب</th><th>الشغف</th>';
      stages.forEach(stage => {
        resultsHtml += `<th>${stage}</th>`;
      });
      resultsHtml += '<th>الإجمالي</th></tr>';

      // عرض النتائج المرتبة
      passionResults.forEach((result, index) => {
        const rowClass = index === 0 ? 'class="best-result"' : '';
        resultsHtml += `<tr ${rowClass}><td>${index + 1}</td><td>${result.passion}</td>`;
        result.stageSums.forEach(sum => {
          resultsHtml += `<td>${sum}</td>`;
        });
        resultsHtml += `<td>${result.total}</td></tr>`;
      });

      resultsTable.innerHTML = resultsHtml;
      printResultsContent.appendChild(resultsTable);

      const topPassion = passionResults[0];
      const recommendationDiv = document.createElement('div');
      recommendationDiv.className = 'print-recommendation';
      recommendationDiv.innerHTML = `
        <h3>🎯 التوصية النهائية</h3>
        <p>الشغف المقترح: ${topPassion.passion}</p>
        <p>بإجمالي ${topPassion.total} نقطة</p>
      `;
      printResultsContent.appendChild(recommendationDiv);

      // إضافة النصيحة الشخصية للطباعة
      const hint = generatePersonalHint(topPassion.passion);
      if (hint) {
        const hintDiv = document.createElement('div');
        hintDiv.className = 'print-hint';
        hintDiv.innerHTML = `
          <h3>💡 نصيحة شخصية</h3>
          <p>${hint}</p>
        `;
        printResultsContent.appendChild(hintDiv);
      }
    }

    // طباعة التقرير
    printReportBtn.addEventListener('click', () => {
      window.print();
    });

    // تحميل التقرير
    downloadReportBtn.addEventListener('click', () => {
      // إنشاء نص التقرير
      let reportText = "تقرير رحلة 6Ps - اكتشف ميولك المهنية\n";
      reportText += "=" .repeat(50) + "\n\n";
      
      // حساب وترتيب النتائج
      let passionResults = [];
      passions.forEach(passion => {
        const stageSums = stages.map(stage => 
          answers[passion][stage].reduce((sum, ans) => sum + parseInt(ans.rating), 0)
        );
        const total = stageSums.reduce((sum, val) => sum + val, 0);
        
        passionResults.push({
          passion: passion,
          stageSums: stageSums,
          total: total
        });
      });

      // ترتيب النتائج من الأعلى للأقل
      passionResults.sort((a, b) => b.total - a.total);

      // عرض النتائج مرتبة حسب التقييم
      passionResults.forEach((result, index) => {
        reportText += `${index + 1}. الشغف: ${result.passion}\n`;
        reportText += "-".repeat(30) + "\n\n";
        
        stages.forEach(stage => {
          reportText += `${stage}:\n`;
          reportText += `السؤال التوجيهي: ${guidingQuestions[stage]}\n`;
          
          // ترتيب الإجابات حسب التقييم (من الأعلى للأقل)
          const sortedAnswers = [...answers[result.passion][stage]].sort((a, b) => {
            // للـ Problems نرتب من الأقل سلبية للأكثر سلبية (الأقل قلقاً أولاً)
            if (stage === 'Problems') {
              return parseInt(b.rating) - parseInt(a.rating); // من -2 إلى -6
            }
            // للباقي نرتب من الأعلى للأقل
            return parseInt(b.rating) - parseInt(a.rating);
          });
          
          sortedAnswers.forEach(answer => {
            reportText += `- ${answer.text} (التقييم: ${answer.rating})\n`;
          });
          reportText += "\n";
        });
        
        reportText += `الإجمالي: ${result.total} نقطة\n`;
        reportText += "=".repeat(50) + "\n\n";
      });
      
      // إضافة التوصية والنصيحة
      const topPassion = passionResults[0];
      reportText += "التوصية النهائية:\n";
      reportText += "-".repeat(20) + "\n";
      reportText += `الشغف المقترح: ${topPassion.passion} (بإجمالي ${topPassion.total} نقطة)\n\n`;
      
      // إضافة النصيحة الشخصية
      const hint = generatePersonalHint(topPassion.passion);
      if (hint) {
        reportText += "نصيحة شخصية:\n";
        reportText += "-".repeat(15) + "\n";
        reportText += `${hint}\n\n`;
      }
      
      reportText += "الترتيب الذي اخترته في البداية:\n";
      reportText += "-".repeat(35) + "\n";
      const sortedPassions = [...passions].sort((a, b) => userPriorities[b] - userPriorities[a]);
      sortedPassions.forEach((passion, index) => {
        reportText += `${index + 1}. ${passion} (الأولوية: ${userPriorities[passion]})\n`;
      });
      
      // إنشاء ملف نصي للتحميل
      const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '6Ps_Report.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // إعادة الاختبار
    restartTestBtn.addEventListener('click', () => {
      if (confirm('هل أنت متأكد من رغبتك في إعادة الاختبار؟ سيتم مسح جميع البيانات الحالية.')) {
        localStorage.removeItem('6ps_journey_data');
        location.reload();
      }
    });

    // حفظ البيانات عند إغلاق الصفحة أو تحديثها
    window.addEventListener('beforeunload', () => {
      saveData();
    });

    // التحقق من وجود بيانات محفوظة عند تحميل الصفحة
    window.addEventListener('load', () => {
      if (!checkSavedData()) {
        // لا توجد بيانات محفوظة، ابدأ اختبار جديد
        updatePassionSelection();
      }
    });
  </script>
</body>
</html>
